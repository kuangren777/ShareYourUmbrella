{% extends 'block/main.html' %}
{% block content %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <style>
        #head_card {
            background-color: #00aefd;
        }
    </style>
    <div id="body">
        <div class="container">
            <div class="row">
                <div class="col">
                    <div class="col-md">
                        <div class="card text-center mb-3" id="head_card" href="#user" role="button"
                             aria-expanded="true" data-bs-toggle="collapse">
                            <div class="card-header">
                                <h5 class="card-title">总注册人数</h5>
                            </div>
                            <div>
                                <h3 class="card-title">{{ num_user }}</h3>
                            </div>
                        </div>
                    </DIV>
                </div>

                <div class="col">
                    <div class="col-md">
                        <div class="card text-center mb-3" id="head_card" href="#umbrella" role="button"
                             aria-expanded="true" data-bs-toggle="collapse">
                            <div class="card-header">
                                <h5 class="card-title">投入伞量</h5>
                            </div>
                            <div>
                                <h3 class="card-title">{{ num_umbrella }}</h3>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="col-md">
                        <div class="card text-center mb-3" id="head_card" href="#log" role="button"
                             aria-expanded="true" data-bs-toggle="collapse">
                            <div class="card-header">
                                <h5 class="card-title">总收益</h5>
                            </div>
                            <div>
                                <h3 class="card-title">￥{{ income }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="col-md">
                        <div class="card text-center mb-3" id="head_card" href="#place" role="button"
                             aria-expanded="true" data-bs-toggle="collapse">
                            <div class="card-header">
                                <h5 class="card-title">总区域数</h5>
                            </div>
                            <div>
                                <h3 class="card-title">{{ loc_num }}</h3>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <form method="POST" action="">
                <div class="collapse" id="user">
                    <div class="card card-body">
                        <div class="col-md">
                            <h1><i class="bi bi-person-circle"></i> 用户列表</h1>
                            <hr>
                            <div class="card card-body">
                                <div class="row">
                                    <div class="col">
                                        <a>对选中用户操作：</a>
                                        <input type="submit" name="option" value="查看信息" class="btn btn-primary">
                                        <input type="submit" name="option" value="删除用户" class="btn btn-warning">
                                    </div>
                                    {% if msg %}
                                        <a>点此查看详情<a class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                                          data-bs-target="#select_user_detail">查看</a></a>
                                    {% endif %}
                                </div>
                                <br>
                                <a class="btn btn-primary btn-sm btn-block" href="/register/">创建用户</a>
                                <table class="table table-sm">
                                    <hr>
                                    <tr>
                                        <th></th>
                                        <th>编号</th>
                                        <th>姓名</th>
                                        <th>昵称</th>
                                        <th>学号</th>
                                        <th>手机号</th>
                                        <th>上次登录日期</th>
                                        <th>账户余额</th>
                                        <th>伞号</th>
                                        <th>优惠券</th>
                                        <th>警报</th>
                                    </tr>
                                    {% csrf_token %}
                                    {% for item in UserInfo_list %}
                                        <tr>
                                            <td>
                                                <input class="form-check-input" type="checkbox" name="user"
                                                       value="{{ item.user_id }}">
                                            </td>
                                            <td>{{ item.user_id }}</td>
                                            <td>{{ item.user_real_name }}</td>
                                            <td>{{ item.username }}</td>
                                            <td>{{ item.user_number }}</td>
                                            <td>{{ item.user_phone }}</td>
                                            <td>{{ item.user_last_login_date|date:"Y-m-d" }}</td>
                                            <td>￥{{ item.user_balance }}</td>
                                            {% if item.user_umbrella_id %}
                                                <td>{{ item.user_umbrella_id }}</td>
                                            {% else %}
                                                <td>未借</td>
                                            {% endif %}
                                            <td>
                                                <a class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                                   data-bs-target="#user_coupon{{ item.user_id }}">查看</a>
                                                <a class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                                   data-bs-target="#add_user_coupon{{ item.user_id }}">添加</a>
                                            </td>
                                            <td>
                                                <a class="btn btn-primary btn-sm btn-block" data-bs-toggle="modal"
                                                   data-bs-target="#check_user_alarm{{ item.user_id }}">查看警报</a>
                                                <a class="btn btn-primary btn-sm btn-block" data-bs-toggle="modal"
                                                   data-bs-target="#add_user_alarm{{ item.user_id }}">添加警报</a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </form>


            <br>

            <div class="collapse" id="umbrella">
                <div class="card card-body">
                    <div class="col-md">
                        <h1><i class="bi bi-umbrella"></i> 伞列表</h1>
                        <hr>
                        <div class="card card-body">
                            <div class="d-flex gap-2">
                                <!-- 入库伞按钮 -->
                                <a class="btn btn-primary btn-sm flex-shrink-0 px-5" data-bs-toggle="modal"
                                   data-bs-target="#import_umbrella">入库伞</a>
                                <!-- 报修伞按钮 -->
                                <a class="btn btn-primary btn-sm flex-shrink-0 px-5" data-bs-toggle="modal"
                                   data-bs-target="#report_repair_umbrella">报修伞</a>
                                <!-- 维修伞按钮 -->
                                <button class="btn btn-primary btn-sm flex-shrink-0 px-5" type="button"
                                        data-bs-toggle="modal" data-bs-target="#repair_umbrella">
                                    维修伞
                                </button>


                            </div>


                            <table class="table table-sm">
                                <tr>
                                    <th>编号</th>
                                    <th>状态</th>
                                    <th>类型</th>
                                    <th>入库日期</th>
                                    <th>上次使用</th>
                                    <th>放置位置</th>
                                    <th>警报</th>
                                    <th>操作</th>
                                </tr>
                                {% for item in Umbrella_list_with_positions %}
                                    <tr>
                                        <td>{{ item.umbrella.umbrella_id }}</td>
                                        <td {% if item.is_alarm %} style="color: red; font-weight: bold;" {% endif %}>
                                            {{ item.status }}
                                        </td>
                                        <td>{{ item.umbrella.umbrella_type_id.umbrella_type }}</td>
                                        <td>{{ item.umbrella.umbrella_warehousing_date|date:"Y-m-d" }}</td>
                                        <td>{{ item.umbrella.umbrella_last_used_date|date:"Y-m-d" }}</td>
                                        <td>{{ item.position }}</td>
                                        <td>
                                            <a class="btn btn-primary btn-sm btn-block" data-bs-toggle="modal"
                                               data-bs-target="#check_umbrella_alarm{{ item.umbrella.umbrella_id }}">查看警报</a>
                                            <a class="btn btn-primary btn-sm btn-block" data-bs-toggle="modal"
                                               data-bs-target="#add_umbrella_alarm{{ item.umbrella.umbrella_id }}">添加警报</a>
                                        </td>
                                        <td>
                                            <a class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                               data-bs-target="#umbrella_detail{{ item.umbrella.umbrella_id }}">详情</a>
                                            {% if item.umbrella.umbrella_scrapped %}
                                                <a class="btn btn-dark btn-sm" data-bs-toggle="modal"
                                                   data-bs-target="#umbrella_scrapped{{ item.umbrella.umbrella_id }}">报废</a>
                                            {% elif item.is_in_repair %}
                                                <a class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
                                                   data-bs-target="#umbrella_repair{{ item.umbrella.umbrella_id }}">维修</a>
                                                <!-- 调度按钮 -->
                                                <a class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                                   data-bs-target="#umbrella_dispatch{{ item.umbrella.umbrella_id }}">调度</a>
                                            {% else %}
                                                <a class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                                   data-bs-target="#report_repair{{ item.umbrella.umbrella_id }}">报修</a>
                                                <a class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                                   data-bs-target="#umbrella_dispatch{{ item.umbrella.umbrella_id }}">调度</a>
                                            {% endif %}
                                            <!-- 历史评价按钮 -->
                                            <a class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                               data-bs-target="#umbrella_comment{{ item.umbrella.umbrella_id }}">历史评价</a>
                                            <!-- 历史订单按钮 -->
                                            <a class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                               data-bs-target="#dairy_detail{{ item.umbrella.umbrella_id }}">历史订单</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <br>

            <div class="collapse" id="log">
                <div class="card card-body">
                    <div class="col-md">
                        <h1><i class="bi bi-list-task"></i> 使用日志</h1>
                        <hr>
                        <div class="card card-body">
                            <a class="btn btn-primary btn-sm btn-block" href="">刷新日志</a>

                            <table class="table table-sm">
                                <tr>
                                    <th>编号</th>
                                    <th>伞-类型</th>
                                    <th>借伞时间</th>
                                    <th>借伞地点</th>
                                    <th>还伞时间</th>
                                    <th>还伞地点</th>
                                    <th>消费金额</th>
                                </tr>
                                {% for log in log_list %}
                                    <tr>
                                        <td>{{ log.diary_id }}</td>
                                        <td>{{ log.umbrella_id }}</td>
                                        <td>{{ log.lending_time|date:"Y-m-d H:i:s" }}</td>
                                        <td>{{ log.lending_site_id }}</td>
                                        <td>{{ log.return_time|date:"Y-m-d H:i:s" }}</td>
                                        <td>{{ log.return_site_id }}</td>
                                        <td>{{ log.order_price|floatformat:"2" }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapse" id="place">
                <div class="card card-body">
                    <div class="col-md">
                        <h1><i class="bi bi-grid-3x3-gap"></i> 区域表</h1>
                        <hr>
                        <div class="card card-body">
                            <a class="btn btn-primary btn-sm btn-block" data-bs-toggle="modal"
                               data-bs-target="#place_multi_umbrella">批量放置伞</a>
                            <table class="table table-sm">
                                <tr>
                                    <th>编号</th>
                                    <th>区域名</th>
                                    <th>可用/总伞位</th>
                                    <th>警报</th>
                                    <th>操作</th>
                                </tr>
                                {% for item in location_list %}
                                    <tr>
                                        <td>{{ item.site_id }}</td>
                                        <td>{{ item.site_address }}</td>
                                        <td>{{ item.num }}/{{ item.site_store_num }}</td>
                                        <td>{{ item.alarms }}</td>
                                        <td>
                                            <a class="btn btn-primary btn-sm btn-block" data-bs-toggle="modal"
                                               data-bs-target="#place{{ item.site_id }}">详情</a>
                                            <a class="btn btn-primary btn-sm btn-block" data-bs-toggle="modal"
                                               data-bs-target="#check_location_alarm{{ item.site_id }}">查看警报</a>
                                            <a class="btn btn-primary btn-sm btn-block" data-bs-toggle="modal"
                                               data-bs-target="#add_location_alarm{{ item.site_id }}">添加警报</a>

                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>
                            {% for message in messages %}
                                <div class="col-md">
                                    <div class="alert alert-danger" role="alert">
                                        {{ message }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <br>

        {#            <div class="row">#}

        {##}

        {#            </div>#}
        {#            <br>#}
        {#            <div class="row">#}

        {##}
        {##}
        {#        <div class="col-md-7">#}
        {#            <h1><i class="bi bi-list-task"></i> 使用日志</h1>#}
        {#            <hr>#}
        {#            <div class="card card-body">#}
        {#                <a class="btn btn-primary btn-sm btn-block" href="">刷新日志</a>#}
        {##}
        {#                <table class="table table-sm">#}
        {#                    <tr>#}
        {#                        <th>编号</th>#}
        {#                        <th>伞-类型</th>#}
        {#                        <th>借伞时间</th>#}
        {#                        <th>借伞地点</th>#}
        {#                        <th>还伞时间</th>#}
        {#                        <th>还伞地点</th>#}
        {#                        <th>消费金额</th>#}
        {#                    </tr>#}
        {#                    {% for log in log_list %}#}
        {#                        <tr>#}
        {#                            <td>{{ log.id }}</td>#}
        {#                            <td>{{ log.umbrella }}</td>#}
        {#                            <td>{{ log.borrow_time|date:"Y-m-d H:i:s" }}</td>#}
        {#                            <td>{{ log.borrow_place }}</td>#}
        {#                            <td>{{ log.back_time|date:"Y-m-d H:i:s" }}</td>#}
        {#                            <td>{{ log.back_place }}</td>#}
        {#                            <td>{{ log.price }}</td>#}
        {#                        </tr>#}
        {#                    {% endfor %}#}
        {#                </table>#}
        {#            </div>#}
        {#        </div>#}
        {#            </div>#}
        {#        </div>#}

        <!-- 入库伞模态框 -->
        <div class="modal fade" id="import_umbrella" tabindex="-1" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">入库伞</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" action="/import_umbrella/">
                            {% csrf_token %}
                            <input hidden="true" name="user" value="{{ request.user.username }}">
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">伞类型:</label>
                                {{ Import_Umbrella_Form.umbrella_type_id }}
                            </div>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">成本价：</label>
                                {{ Import_Umbrella_Form.umbrella_cost_price }}
                            </div>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">批次数量：</label>
                                <input class="form-control" name="quantity">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭
                                </button>
                                <input type="submit" class="btn btn-primary" value="确认">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <!-- 报修伞模态框 -->
        <div class="modal fade" id="report_repair_umbrella" tabindex="-1" aria-labelledby="reportRepairUmbrellaLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="reportRepairUmbrellaLabel">报修伞</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" action="/report_repair_umbrella/">
                            {% csrf_token %}
                            {{ ReportRepairUmbrellaForm.as_p }}
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <input type="submit" class="btn btn-primary" value="确认">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <!-- 维修伞模态框 -->
        <div class="modal fade" id="repair_umbrella" tabindex="-1" aria-labelledby="repairUmbrellaLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="reportRepairUmbrellaLabel">维修伞</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" action="/repair_umbrella/">
                            {% csrf_token %}

                            <!-- 维修类型下拉菜单 -->
                            <div class="mb-3">
                                <label for="repairTypeSelect" class="form-label">维修类型</label>
                                <select id="repairTypeSelect" name="repair_type_id" class="form-select">
                                    <option value="">请选择维修类型</option>
                                    {% for repair_type in repair_types %}
                                        <option value="{{ repair_type.repair_type_id }}">{{ repair_type.repair_type_id }}.{{ repair_type.repair_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- 需要维修的雨伞下拉菜单 -->
                            <div class="mb-3">
                                <label for="umbrellaSelect" class="form-label">伞编号</label>
                                <select id="umbrellaSelect" name="umbrella_id" class="form-select">
                                    <option value="">请选择伞编号</option>
                                </select>
                            </div>

                            <!-- 备注区域 -->
                            <div class="mb-3">
                                <label for="notes" class="form-label">备注</label>
                                <textarea id="notes" name="notes" class="form-control"></textarea>
                            </div>


                            <div class="mb-3">
                                <label class="form-label">是否维修完成，不勾选表示报废该伞</label>
                                <div>{{ RepairUmbrellaForm.is_repaired }}</div>
                            </div>
                            <!-- 其他字段 -->


                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <input type="submit" class="btn btn-primary" value="确认">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 批量放置伞模态框 -->
        <div class="modal fade" id="place_multi_umbrella" tabindex="-1" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">批量放置伞</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="POST" action="/place_umbrella/">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="start-umbrella-id" class="col-form-label">伞起始编号：</label>
                                <input type="number" class="form-control" name="start" id="start-umbrella-id">
                            </div>

                            <div class="mb-3">
                                <label for="end-umbrella-id" class="col-form-label">伞结束编号：</label>
                                <input type="number" class="form-control" name="end" id="end-umbrella-id">
                            </div>

                            <div class="mb-3">
                                <label for="site-select" class="col-form-label">放置地点:</label>
                                <select class="form-select" name="place" id="site-select">
                                    <option value="">选择站点</option>
                                    {% for site in location_list %}
                                        <option value="{{ site.site_id }}">{{ site.site_id }}. {{ site.site_address }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            <input type="submit" class="btn btn-primary" value="确认">
                        </div>
                    </form>
                </div>
            </div>
        </div>


        {% for place in pls %}
            <div class="modal fade modal-lg" id="place{{ place.id }}" tabindex="-1"
                 aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">{{ place.name }}放置情况</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="container-sm col-md">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th>第<i class="bi bi-1-circle"></i>列</th>
                                        <th>第<i class="bi bi-2-circle"></i>列</th>
                                        <th>第<i class="bi bi-3-circle"></i>列</th>
                                        <th>第<i class="bi bi-4-circle"></i>列</th>
                                        <th>第<i class="bi bi-5-circle"></i>列</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for row in place.table %}
                                        <tr>
                                            {% for item in row %}
                                                {% if item %}
                                                    <th>{{ item }}</th>
                                                {% else %}
                                                    <th><i class="bi bi-umbrella"></i></th>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        {% for user in UserInfo_list %}
            <div class="modal fade" id="confirm{{ user.id }}" tabindex="-1" aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">确定要删除{{ user.name }}吗？</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭
                            </button>
                            <a class="btn btn-danger" href="delete/?name={{ user.username }}">
                                删除
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        {% for item in Umbrella_list_with_positions %}
            <div class="modal fade" id="umbrella_detail{{ item.umbrella.umbrella_id }}" tabindex="-1"
                 aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title fs-5" id="exampleModalLabel">{{ item.umbrella }}详情</h3>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>

                        <div class="modal-body">
                            <div class="container-sm col-md">
                                位置：{{ item.position }}
                            </div>
                        </div>

                        <div class="modal-footer">
                            <a type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                确定
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        {% for item in Umbrella_list_with_positions %}
            <div class="modal fade" id="umbrella_scrapped{{ item.umbrella.umbrella_id }}" tabindex="-1"
                 aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title fs-5" id="exampleModalLabel">{{ item.umbrella }}已报废</h3>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>

                        <div class="modal-body">
                            <div class="container-sm col-md">
                                该伞已报废，不可维修与调度。
                            </div>
                        </div>

                        <div class="modal-footer">
                            <a type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                确定
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        {% if msg %}
            <div class="modal fade" id="select_user_detail" tabindex="-1" aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title fs-5" id="exampleModalLabel">借伞详情</h3>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            {% for user in msg %}
                                <h3>{{ user.username }}：</h3>
                                <table>
                                    <thead>
                                    <tr>
                                        <th>伞类型</th>
                                        <th>借伞时间</th>
                                        <th>借伞地点</th>
                                        <th>还伞时间</th>
                                        <th>还伞地点</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for log in user.detail %}
                                        <tr>
                                            <td>{{ log.umbrella_id }}</td>
                                            <td>{{ log.lending_time|date:"Y-m-d" }}</td>
                                            <td>{{ log.lending_site_id }}</td>
                                            <td>{{ log.return_time|date:"Y-m-d" }}</td>
                                            <td>{{ log.return_site_id }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            {% endfor %}
                        </div>
                        <div class="modal-footer">
                            <a type="button" class="btn btn-secondary" data-bs-dismiss="modal">确定</a>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}


    </div>

    {% for item in Umbrella_list_with_positions %}
        <div class="modal fade" id="report_repair{{ item.umbrella.umbrella_id }}" tabindex="-1"
             aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title fs-5" id="exampleModalLabel">{{ item.umbrella }}报修</h3>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        <!-- 报修表单 -->
                        <form method="post" action="/report-repair/{{ item.umbrella.umbrella_id }}/">
                            {% csrf_token %}
                            <input type="hidden" name="umbrella_id" value="{{ item.umbrella.umbrella_id }}">
                            <label for="repair_type_id{{ item.umbrella.umbrella_id }}">维修类型：</label>
                            <select id="repair_type_id{{ item.umbrella.umbrella_id }}" name="repair_type_id"
                                    class="form-select">
                                {% for type in repair_types %}
                                    <option value="{{ type.repair_type_id }}">{{ type }}</option>
                                {% endfor %}
                            </select>
                            <label for="notes">备注：</label>
                            <textarea id="notes" name="notes" class="form-control"></textarea>
                            <button type="submit" class="btn btn-primary mt-2">提交报修</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    {% for item in Umbrella_list_with_positions %}
        <div class="modal fade" id="umbrella_repair{{ item.umbrella.umbrella_id }}" tabindex="-1"
             aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <!-- 模态框头部 -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">维修详情 - {{ item.umbrella }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <!-- 模态框主体 -->
                    <div class="modal-body">
                        <!-- 表单，直接硬编码URL -->
                        <form method="post" action="/update-repair/{{ item.umbrella.umbrella_id }}/">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="repair_type_{{ item.umbrella.umbrella_id }}"
                                       class="form-label">维修类型</label>
                                <select class="form-select" id="repair_type_{{ item.umbrella.umbrella_id }}"
                                        name="repair_type_id">
                                    {% for type in repair_types %}
                                        <option value="{{ type.repair_type_id }}"
                                                {% if item.latest_repair and type.repair_type_id == item.latest_repair.repair_type_id.repair_type_id %}
                                                selected {% endif %}>
                                            {{ type.repair_type_id }}. {{ type.repair_type }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="notes_{{ item.umbrella.umbrella_id }}" class="form-label">备注</label>
                                <textarea class="form-control" id="notes_{{ item.umbrella.umbrella_id }}"
                                          name="notes">{{ item.latest_repair.notes }}</textarea>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input"
                                       id="completed_{{ item.umbrella.umbrella_id }}" name="completed">
                                <label class="form-check-label"
                                       for="completed_{{ item.umbrella.umbrella_id }}">维修完成，不勾选则报废</label>
                            </div>
                            <button type="submit" class="btn btn-primary">更新维修信息</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    <!-- 伞调度模态框 -->
    {% for item in Umbrella_list_with_positions %}
        <!-- 模态框 -->
        <div class="modal fade" id="umbrella_dispatch{{ item.umbrella.umbrella_id }}" tabindex="-1"
             aria-labelledby="dispatchModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dispatchModalLabel">伞调度 - {{ item.umbrella }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" action="/umbrella-dispatch/{{ item.umbrella.umbrella_id }}/">
                            {% csrf_token %}
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input"
                                       id="no_dispatch_{{ item.umbrella.umbrella_id }}"
                                       onchange="toggleDispatchDetails('{{ item.umbrella.umbrella_id }}')">
                                <label class="form-check-label"
                                       for="no_dispatch_{{ item.umbrella.umbrella_id }}">不放置伞</label>
                            </div>
                            <div id="dispatch_details_{{ item.umbrella.umbrella_id }}">
                                <div class="mb-3">
                                    <label for="site_id_{{ item.umbrella.umbrella_id }}" class="form-label">站点</label>
                                    <select class="form-select" id="site_id_{{ item.umbrella.umbrella_id }}"
                                            name="site_id"
                                            onchange="updateLayIdOptions('{{ item.umbrella.umbrella_id }}', this.value)">
                                        <option value="">选择站点</option>
                                        {% for site in location_list %}
                                            <option value="{{ site.site_id }}">{{ site.site_id }}. {{ site.site_address }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="lay_id_{{ item.umbrella.umbrella_id }}"
                                           class="form-label">放置序号</label>
                                    <select class="form-select" id="lay_id_{{ item.umbrella.umbrella_id }}"
                                            name="lay_id">
                                        <!-- 选项将通过JavaScript动态加载 -->
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">提交调度</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    {% for item in Umbrella_list_with_positions %}
        <!-- 模态框 -->
        <div class="modal fade" id="umbrella_comment{{ item.umbrella.umbrella_id }}" tabindex="-1"
             aria-labelledby="commentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="commentModalLabel">伞{{ item.umbrella }}的历史评价</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% if item.comments %}
                            {% for comment in item.comments %}
                                <p><strong>评分：</strong>{{ comment.comment_score }} / 时间：{{ comment.comment_time }}
                                </p>
                                <p>评价内容：{{ comment.comment_content }}</p>
                                <hr>
                            {% endfor %}
                        {% else %}
                            <p>没有历史评价。</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    {% for item in Umbrella_list_with_positions %}
        <!-- 模态框 -->
        <div class="modal fade" id="dairy_detail{{ item.umbrella.umbrella_id }}" tabindex="-1"
             aria-labelledby="orderModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="orderModalLabel">伞{{ item.umbrella.umbrella_id }}的历史订单</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% if item.diaries %}
                            {% for diary in item.diaries %}
                                <div class="mb-2">
                                    <p><strong>借出站点：</strong>{{ diary.lending_site_id.site_address }} /
                                        序号：{{ diary.lending_lay_id }}</p>
                                    <p><strong>归还站点：</strong>
                                        {% if diary.return_site_id %}
                                            {{ diary.return_site_id.site_address }}
                                        {% else %}
                                            未归还
                                        {% endif %}
                                        / 序号：
                                        {% if diary.return_lay_id %}
                                            {{ diary.return_lay_id }}
                                        {% else %}
                                            未归还
                                        {% endif %}
                                    </p>
                                    <p><strong>借出时间：</strong>{{ diary.lending_time }} </p>
                                    <p><strong>归还时间：</strong>
                                        {% if diary.return_time %}
                                            {{ diary.return_time }}
                                        {% else %}
                                            未归还
                                        {% endif %}
                                    </p>
                                    <p><strong>费用：</strong>{{ diary.order_price }}</p>
                                </div>
                                <hr>
                            {% endfor %}
                        {% else %}
                            <p>没有历史订单。</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    {% for item in UserInfo_list %}
        <!-- 用户优惠券模态框 -->
        <div class="modal fade" id="user_coupon{{ item.user_id }}" tabindex="-1"
             aria-labelledby="couponModalLabel{{ item.user_id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="couponModalLabel{{ item.user_id }}">优惠券列表</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% if item.coupons|length > 0 %}
                            <ul>
                                {% for coupon in item.coupons %}
                                    <li>
                                        {% if coupon.coupon_type %}
                                            类型: 满减券
                                            <br>
                                            <strong>
                                                满{{ coupon.satisfied_amount }}元 减
                                                {{ coupon.discount_price }}元
                                            </strong>
                                        {% else %}
                                            类型: 打折券
                                            <br>
                                            <strong> 满{{ coupon.satisfied_amount }}元 打
                                                {{ coupon.discount_price|floatformat:0 }} 折
                                            </strong>
                                        {% endif %}
                                        <br>
                                        有效期: {{ coupon.effective_time|date:'y-m-d' }}至{{ coupon.expire_time|date:'y-m-d' }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>此用户没有优惠券。</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}


    {% for item in UserInfo_list %}
        <!-- 添加优惠券模态框 -->
        <div class="modal fade" id="add_user_coupon{{ item.user_id }}" tabindex="-1"
             aria-labelledby="addCouponModalLabel{{ item.user_id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addCouponModalLabel{{ item.user_id }}">添加优惠券</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" action="/add_coupon/">
                        {% csrf_token %}
                        <div class="modal-body">
                            <input type="hidden" name="user_id" value="{{ item.user_id }}">
                            <div class="mb-3">
                                <label for="coupon_type" class="form-label">优惠券类型</label>
                                <select class="form-select" name="coupon_type">
                                    <option value="1">满减</option>
                                    <option value="0">打折</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="satisfied_amount" class="form-label">满足金额</label>
                                <input type="number" class="form-control" name="satisfied_amount">
                            </div>
                            <div class="mb-3">
                                <label for="discount_price" class="form-label">折扣力度</label>
                                <input type="number" class="form-control" name="discount_price">
                            </div>
                            <div class="mb-3">
                                <label for="effective_time{{ item.user_id }}" class="form-label">生效时间</label>
                                <input type="datetime-local" class="form-control" name="effective_time"
                                       id="effective_time{{ item.user_id }}">
                                <button type="button" class="btn btn-outline-secondary btn-sm mt-1"
                                        onclick="setCurrentTime('{{ item.user_id }}')">现在
                                </button>
                            </div>
                            <div class="mb-3">
                                <label for="expire_time{{ item.user_id }}" class="form-label">失效时间</label>
                                <input type="datetime-local" class="form-control" name="expire_time"
                                       id="expire_time{{ item.user_id }}">
                                <div class="btn-group mt-1" role="group" aria-label="Quick set expire time">
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="setExpireTime('{{ item.user_id }}', 1)">1天
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="setExpireTime('{{ item.user_id }}', 7)">7天
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="setExpireTime('{{ item.user_id }}', 10)">10天
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="setExpireTime('{{ item.user_id }}', 30)">一个月
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="setExpireTime('{{ item.user_id }}', 90)">三个月
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="setExpireTime('{{ item.user_id }}', 180)">半年
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="setExpireTime('{{ item.user_id }}', 365)">一年
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="setExpireTime('{{ item.user_id }}', '永久')">永久
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary">添加</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endfor %}

    <!-- 模态框 -->
    {% for item in location_list %}
        <div class="modal fade" id="check_location_alarm{{ item.site_id }}" tabindex="-1" aria-labelledby="modalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">站点{{ item.site_id }}的警报</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% for alarm in item.alarm_details %}
                            <div class="alarm-item">
                                <p>警报类型: {{ alarm.alarm_type_id.alarm_type }}
                                    <!-- 删除警报的按钮 -->
                                    <button class="btn btn-danger btn-sm"
                                            onclick="deleteLocationAlarm({{ alarm.alarm_id }})">
                                        删除警报
                                    </button>
                                </p>
                            </div>
                        {% empty %}
                            <p>没有活动警报。</p>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    <!-- 模态框 -->
    {% for item in location_list %}
        <div class="modal fade" id="add_location_alarm{{ item.site_id }}" tabindex="-1" aria-labelledby="modalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">站点{{ item.site_id }} - 添加警报</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 添加警报的表单 -->
                        <form method="post" action="/add_location_alarm/">
                            {% csrf_token %}
                            <input type="hidden" name="site_id" value="{{ item.site_id }}">
                            <!-- 警报类型选择 -->
                            <div class="mb-3">
                                <label for="alarm_type" class="form-label">警报类型</label>
                                <select class="form-select" id="alarm_type" name="alarm_type">
                                    {% for alarm_type in alarm_types %}
                                        <option value="{{ alarm_type.alarm_type_id }}">{{ alarm_type.alarm_type_id }}. {{ alarm_type.alarm_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- 其他表单字段 -->
                            <button type="submit" class="btn btn-primary">添加警报</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    {% for item in UserInfo_list %}
        <!-- 查看警报的模态框 -->
        <div class="modal fade" id="check_user_alarm{{ item.user_id }}" tabindex="-1" aria-labelledby="modalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">用户{{ item.user_id }}的警报</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 在这里插入警报信息 -->
                        {% for alarm in item.alarm_details %}
                            <p>警报类型: {{ alarm.alarm_type_id }}
                                <!-- 删除警报的按钮 -->
                                <button class="btn btn-danger btn-sm" onclick="deleteUserAlarm({{ alarm.alarm_id }})">
                                    删除警报
                                </button>
                            </p>
                        {% empty %}
                            <p>没有警报。</p>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}


    {% for item in UserInfo_list %}
        <!-- 添加警报的模态框 -->
        <div class="modal fade" id="add_user_alarm{{ item.user_id }}" tabindex="-1" aria-labelledby="modalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">为用户{{ item.user_id }}添加警报</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" action="/add_user_alarm/">
                            {% csrf_token %}
                            <input type="hidden" name="user_id" value="{{ item.user_id }}">
                            <div class="mb-3">
                                <label for="alarm_type" class="form-label">警报类型</label>
                                <select class="form-select" id="alarm_type" name="alarm_type">
                                    {% for alarm_type in alarm_types %}
                                        <option value="{{ alarm_type.alarm_type_id }}">{{ alarm_type.alarm_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">添加警报</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    {% for item in Umbrella_list_with_positions %}
        <!-- 查看警报的模态框 -->
        <div class="modal fade" id="check_umbrella_alarm{{ item.umbrella.umbrella_id }}" tabindex="-1"
             aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">雨伞{{ item.umbrella.umbrella_id }}的警报</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 在这里插入警报信息 -->
                        {% for alarm in item.umbrella.umbrella_alarm_details %}
                            <p>
                                警报类型: {{ alarm.alarm_type_id }}
                                <button class="btn btn-danger btn-sm"
                                        onclick="deleteUserAlarm({{ alarm.alarm_id }})">
                                    删除警报
                                </button>
                            </p>
                        {% empty %}
                            <p>没有警报。</p>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    {% for item in Umbrella_list_with_positions %}
        <!-- 添加警报的模态框 -->
        <div class="modal fade" id="add_umbrella_alarm{{ item.umbrella.umbrella_id }}" tabindex="-1"
             aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">为雨伞{{ item.umbrella.umbrella_id }}添加警报</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" action="/add_umbrella_alarm/">
                            {% csrf_token %}
                            <input type="hidden" name="umbrella_id" value="{{ item.umbrella.umbrella_id }}">
                            <div class="mb-3">
                                <label for="alarm_type" class="form-label">警报类型</label>
                                <select class="form-select" id="alarm_type" name="alarm_type">
                                    {% for alarm_type in alarm_types %}
                                        <option value="{{ alarm_type.alarm_type_id }}">{{ alarm_type.alarm_type_id }}. {{ alarm_type.alarm_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">添加警报</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}



    <!-- 外层容器 -->
    <div class="container">
        <!-- 卡片行 -->
        <div class="row">
            <!-- 伞类型统计图卡片 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">伞类型统计图</h5>
                        <canvas id="umbrellaChart" width="50" height="50"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">站点雨伞数量统计</h5>
                        <canvas id="siteUmbrellaChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="row">
            <!-- 用户租借历史 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">用户租借历史</h5>
                        <canvas id="userRentalHistoryChart" width="80" height="40"></canvas>
                    </div>
                </div>
                <br>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">每月注册数量</h5>
                        <canvas id="monthlyRegistrationsChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">用户账户余额统计</h5>
                        <canvas id="userBalanceChart" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function deleteUserAlarm(alarmId) {
            if (confirm("确定要删除这个警报吗？")) {
                fetch("/delete_umbrella_alarm/", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({'alarm_id': alarmId})
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 移除警报信息或者重新加载页面
                            location.reload();
                        } else {
                            alert("删除失败");
                        }
                    });
            }
        }
    </script>


    <script>
        function deleteLocationAlarm(alarmId) {
            if (confirm("确定要删除这个警报吗？")) {
                fetch("/delete_location_alarm/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({alarm_id: alarmId})
                }).then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload(); // 重新加载页面以更新警报列表
                        }
                    });
            }
        }
    </script>

    <script>
        function deleteUserAlarm(alarmId) {
            if (confirm("确定要删除这个警报吗？")) {
                fetch("/delete_user_alarm/", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({'alarm_id': alarmId})
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload(); // 成功后重新加载页面
                        } else {
                            alert("删除失败");
                        }
                    });
            }
        }
    </script>



    <script>
        var ctx = document.getElementById('umbrellaChart').getContext('2d');
        var umbrellaChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: {{ umbrella_types | safe }},
                datasets: [{
                    label: '伞的数量',
                    data: {{ umbrella_counts | safe }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        // ...其他颜色
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        // ...其他颜色
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                // 配置项
            }
        });
    </script>

    <script>
        {#// 设置 canvas 父元素的大小#}
        {#var canvasParent = document.getElementById('userBalanceChart').parentNode;#}
        {##}
        {#canvasParent.style.width = '1000px';   // 宽度#}
        {#canvasParent.style.height = '600px';  // 高度#}

        var ctx = document.getElementById('userBalanceChart').getContext('2d');
        var userBalanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ user_names | safe }},
                datasets: [{
                    label: '用户余额',
                    data: {{ user_balances | safe }},
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>

    <script>
        var ctx = document.getElementById('siteUmbrellaChart').getContext('2d');
        var siteUmbrellaChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ site_ids | safe }},
                datasets: [{
                    label: '伞数量',
                    data: {{ umbrella_counts_11 | safe }},
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>

    <script>
        var ctx = document.getElementById('userRentalHistoryChart').getContext('2d');
        var userRentalHistoryChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ dates | safe }},
                datasets: [{
                    label: '出租数量',
                    data: {{ counts | safe }},
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>

    <script>
        var ctx = document.getElementById('monthlyRegistrationsChart').getContext('2d');
        var monthlyRegistrationsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ months | safe }},
                datasets: [{
                    label: '每月注册数量',
                    data: {{ counts | safe }},
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>

    <script>
        function toggleDispatchDetails(umbrellaId) {
            var checkBox = document.getElementById("no_dispatch_" + umbrellaId);
            var dispatchDetails = document.getElementById("dispatch_details_" + umbrellaId);
            dispatchDetails.style.display = checkBox.checked ? "none" : "block";
        }

        function updateLayIdOptions(umbrellaId, siteId) {
            if (siteId) {
                fetch(`/get_free_positions/${siteId}/`)
                    .then(response => response.json())
                    .then(data => {
                        var layIdSelect = document.getElementById('lay_id_' + umbrellaId);
                        layIdSelect.innerHTML = ''; // 清空现有选项
                        data.free_positions.forEach(function (layId) {
                            layIdSelect.options[layIdSelect.options.length] = new Option(layId, layId);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                document.getElementById('lay_id_' + umbrellaId).innerHTML = ''; // 如果没有站点ID，则清空放置序号的选项
            }
        }
    </script>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // 当任意一个可折叠区域被点击时
            $('.collapse').on('show.bs.collapse', function () {
                // 获取当前被点击的区域的ID
                var active = $(this).attr('id');
                // 遍历所有可折叠区域
                $('.collapse').each(function () {
                    // 如果不是当前被点击的区域，则折叠它
                    if ($(this).attr('id') !== active) {
                        $(this).collapse('hide');
                    }
                });
            });
        });
    </script>

    <script>
        $(document).ready(function () {
            $('#repairTypeSelect').change(function () {
                var repairTypeId = $(this).val();
                $.ajax({
                    url: '/get_umbrellas_for_repair/' + repairTypeId,
                    success: function (data) {
                        var umbrellasSelect = $('#umbrellaSelect');
                        umbrellasSelect.empty();
                        umbrellasSelect.append('<option value="">请选择伞编号</option>');
                        data.umbrellas.forEach(function (umbrella) {
                            umbrellasSelect.append('<option value="' + umbrella.umbrella_id + '">' + umbrella.umbrella_id + '号伞' + '</option>');
                        });
                    }
                });
            });

            $('#umbrellaSelect').change(function () {
                var umbrellaId = $(this).val();
                $.ajax({
                    url: '/get_repair_notes/' + umbrellaId,
                    success: function (data) {
                        $('#notes').val(data.notes);
                    }
                });
            });
        });
    </script>

    <script>
        // 优惠券生效失效时间设置
        function setCurrentTime(userId) {
            var now = new Date();
            var dateTimeLocal = now.toISOString().slice(0, 16); // 转换为 datetime-local 输入需要的格式
            document.getElementById('effective_time' + userId).value = dateTimeLocal;
        }

        function setExpireTime(userId, days) {
            var expireInput = document.getElementById('expire_time' + userId);
            var now = new Date();

            if (days === '永久') {
                now.setFullYear(now.getFullYear() + 100); // 设置为当前日期加上100年
            } else {
                now.setDate(now.getDate() + days); // 添加指定的天数
            }

            var dateTimeLocal = now.toISOString().slice(0, 16); // 转换为 datetime-local 输入需要的格式
            expireInput.value = dateTimeLocal;
        }

    </script>


{% endblock %}